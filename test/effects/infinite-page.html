<!doctype html>
<html>
<head>
	<meta name=viewport content=width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1>
	<title>Infinite scroll</title>
	<link rel="stylesheet" type="text/css" href="css/normalize.css">
	<link rel="stylesheet" type="text/css" href="css/topcoat.css">
	<link rel="stylesheet" href="css/infinite-style.css">
</head>
<body>

<header>
	<ul class='dark-header-bar'>
		<li>
			<a class="home dark-button" href="./infinite.html">Home</a>
		</li>
		<li>
			<a href="#">Some gallery name</a>
		</li>
	</ul>
</header>

<div id="main">
	<ul class='content'>
		<li class='pull-to-refresh'>
			<span>Pull down to refresh</span> <img src="./img/arrow.png">
		</li>
		<li class='loading'>
			Loading <img src="img/loading.png" class="spinner">
		</li>
	</ul>
</div>

<script src="./js/infinite-script.js"></script>
<script>
	var url = 'http://www.behance.net/v2/wips?q=menu&api_key=G3MhC2vngtUtyqElPighmE9kt9o3aBQc&page=';
	var data;
	var page = 1;
	var count = 0;
	var fetching = 0;
	var stop = 0;
	var scrolling = 0;

	var startY = 0;

	function documentHeight() {
		return Math.max(
			Math.max(document.body.scrollHeight, document.documentElement.scrollHeight),
			Math.max(document.body.offsetHeight, document.documentElement.offsetHeight),
			Math.max(document.body.clientHeight, document.documentElement.clientHeight)
		);
	}

	var getJSONP = url + page + "&callback=JSONPCallback";
	jsonp.fetch(getJSONP, function(d) {
		data = d.wips;
		createListWithImages(data, 8);
	});

	window.addEventListener('scroll', function(){
		if(stop || fetching) return;
		var pageHeight = document.documentElement.clientHeight;
		var scrollPosition = content.pageYOffset || content.offsetTop;
		var docHeight = documentHeight();
		if (pageHeight + scrollPosition > docHeight - 70) {

			if(cache.length) {
				console.log('cache length is ', cache.length);
				createListWithImages(cache);
				return;
			}
			console.log('nothing is cache going for new ' , stop);
			fetching = 1;
			var getJSONP = url + page + "&callback=JSONPCallback";
			jsonp.fetch(getJSONP, function(d) {
				data = d.wips;
				if(!d.wips.length) {
					document.querySelector('.loading').innerHTML = 'That was the last result';
					stop = 1;
				} else {
					createListWithImages(d.wips);
					page++;
					fetching = 0;
				}
			});
		}
	}, false);

</script>

</body>
</html>